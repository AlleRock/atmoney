<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AleTaMoney</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/AlleRock/atmoney/main/icona.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .ios-blur { backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-28">

    <header class="sticky top-0 z-30 bg-white/80 ios-blur border-b border-slate-100 px-6 pt-14 pb-5 flex justify-between items-center">
        <h1 class="text-2xl font-black text-slate-800 tracking-tighter italic">AleTaMoney</h1>
        <div class="flex items-center gap-2">
            <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">v6.0</span>
            <div id="status-dot" class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></div>
        </div>
    </header>

    <main id="page-home" class="p-6 space-y-8 max-w-md mx-auto">
        <section class="bg-white rounded-[2.5rem] p-8 card-shadow border border-slate-50 relative overflow-hidden text-center">
            <h2 class="text-[10px] uppercase tracking-[0.2em] text-slate-400 font-heavy mb-2 italic">Credito Totale</h2>
            <div id="total-balance" class="text-5xl font-black tracking-tight transition-all">€ 0.00</div>
        </section>

        <section class="bg-white rounded-3xl p-6 card-shadow border border-slate-50 space-y-4">
            <input id="edit-id" type="hidden">
            <input id="desc" type="text" placeholder="Chi o per cosa?" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-blue-100 transition-all text-lg font-medium">
            <div class="flex gap-3">
                <input id="amount" type="number" step="0.01" placeholder="Importo €" class="w-2/3 p-4 bg-slate-50 rounded-2xl outline-none font-bold text-lg">
                <input id="date" type="date" class="w-1/3 p-4 bg-slate-50 rounded-2xl outline-none text-xs font-bold text-slate-500">
            </div>
            <div class="grid grid-cols-2 gap-4 pt-2">
                <button id="btn-out" onclick="addEntry('out')" class="bg-blue-600 text-white font-extrabold py-5 rounded-2xl active:scale-95 shadow-xl shadow-blue-200">HO DATO</button>
                <button id="btn-in" onclick="addEntry('in')" class="bg-orange-500 text-white font-extrabold py-5 rounded-2xl active:scale-95 shadow-xl shadow-orange-200">TORNATI</button>
            </div>
            <button id="btn-cancel-edit" onclick="cancelEdit()" class="hidden w-full text-slate-400 text-xs font-bold py-2 uppercase tracking-widest text-center">Annulla Modifica</button>
        </section>
    </main>

    <main id="page-history" class="hidden p-6 max-w-md mx-auto">
        <h2 class="text-3xl font-black text-slate-800 italic mb-6">Lista Movimenti</h2>
        <div id="history-list" class="space-y-4"></div>
    </main>

    <main id="page-settings" class="hidden p-6 max-w-md mx-auto space-y-6">
        <h2 class="text-3xl font-black text-slate-800 italic mb-2">Dati & Backup</h2>
        
        <div class="bg-white rounded-3xl p-6 card-shadow border border-slate-50 space-y-6">
            <div>
                <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-3">Backup Professionale (JSON)</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportToJSON()" class="bg-slate-800 text-white text-[10px] font-bold py-4 rounded-xl uppercase tracking-widest active:scale-95 transition-all">Salva Backup</button>
                    <label class="bg-blue-600 text-white text-[10px] font-bold py-4 rounded-xl uppercase tracking-widest text-center cursor-pointer active:scale-95 transition-all">
                        Carica Backup
                        <input type="file" id="json-file" accept=".json" class="hidden" onchange="importFromJSON(event)">
                    </label>
                </div>
                <p class="text-[9px] text-slate-400 mt-2">Usa questo per trasferire i dati tra dispositivi senza errori.</p>
            </div>

            <div class="pt-6 border-t border-slate-100">
                <h3 class="text-sm font-black text-slate-800 uppercase tracking-widest mb-3">Lettura Excel (CSV)</h3>
                <button onclick="exportToCSV()" class="w-full bg-slate-100 text-slate-600 text-[10px] font-bold py-3 rounded-xl uppercase tracking-widest">Esporta per Excel</button>
            </div>

            <div class="pt-6 border-t border-slate-100">
                <h3 class="text-sm font-black text-rose-600 uppercase tracking-widest mb-3">Pericolo</h3>
                <button onclick="clearAllData()" class="w-full bg-rose-50 text-rose-600 text-[10px] font-bold py-4 rounded-xl uppercase tracking-widest border border-rose-100 active:bg-rose-600 active:text-white transition-all">
                    Svuota AleTaMoney
                </button>
            </div>
        </div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 bg-white/90 ios-blur rounded-[2rem] card-shadow border border-white flex justify-around items-center px-4 z-40">
        <button onclick="showPage('home')" id="nav-home" class="flex flex-col items-center">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter">Nuovo</span>
        </button>
        <button onclick="showPage('history')" id="nav-history" class="flex flex-col items-center opacity-30">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter">Lista</span>
        </button>
        <button onclick="showPage('settings')" id="nav-settings" class="flex flex-col items-center opacity-30">
            <svg class="w-6 h-6 mb-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path></svg>
            <span class="text-[10px] font-black uppercase tracking-tighter text-center">Dati</span>
        </button>
    </nav>

    <script>
        let entries = JSON.parse(localStorage.getItem('aleta_v6_db')) || [];

        function addEntry(type) {
            let desc = document.getElementById('desc').value;
            const amountVal = document.getElementById('amount').value;
            const date = document.getElementById('date').value;
            const editId = document.getElementById('edit-id').value;

            if (!amountVal || !date) return alert("Mancano dati!");
            if (!desc && type === 'in') desc = "Rientro";
            if (!desc && type === 'out') return alert("Chi ha ricevuto i soldi?");

            const amount = Math.abs(parseFloat(amountVal));
            
            if (editId) {
                const index = entries.findIndex(e => e.id == editId);
                entries[index] = { ...entries[index], desc, amount: type === 'out' ? amount : -amount, date, type };
                cancelEdit();
            } else {
                entries.unshift({ id: Date.now(), desc, amount: type === 'out' ? amount : -amount, date, type });
            }

            save();
            updateUI();
            resetForm();
            showPage('history');
        }

        function clearAllData() {
            if(confirm("Vuoi cancellare tutto? Questa azione non si può annullare.")) {
                entries = [];
                save();
                updateUI();
                alert("Database svuotato.");
            }
        }

        // --- GESTIONE JSON ---
        function exportToJSON() {
            if (entries.length === 0) return alert("Nessun dato da salvare.");
            const dataStr = JSON.stringify(entries, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AleTaMoney_Backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (Array.isArray(importedData)) {
                        if(confirm("Vuoi sovrascrivere i dati attuali con quelli del backup?")) {
                            entries = importedData;
                            save();
                            updateUI();
                            alert("Dati importati con successo!");
                        }
                    } else {
                        alert("File JSON non valido.");
                    }
                } catch (err) {
                    alert("Errore durante la lettura del file.");
                }
            };
            reader.readAsText(file);
        }

        // --- GESTIONE CSV ---
        function exportToCSV() {
            if (entries.length === 0) return alert("Nessun dato!");
            let csv = "Data;Descrizione;Tipo;Importo\n";
            entries.forEach(e => csv += `${e.date};${e.desc};${e.type === 'out' ? 'Dato' : 'Tornato'};${Math.abs(e.amount).toFixed(2)}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AleTaMoney_Report.csv`;
            link.click();
        }

        function editEntry(id) {
            const entry = entries.find(e => e.id == id);
            document.getElementById('edit-id').value = entry.id;
            document.getElementById('desc').value = entry.desc;
            document.getElementById('amount').value = Math.abs(entry.amount);
            document.getElementById('date').value = entry.date;
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-out').innerText = "CONFERMA";
            document.getElementById('btn-in').innerText = "CONFERMA";
            showPage('home');
        }

        function cancelEdit() {
            resetForm();
            document.getElementById('edit-id').value = '';
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-out').innerText = "HO DATO";
            document.getElementById('btn-in').innerText = "TORNATI";
        }

        function resetForm() {
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        function deleteEntry(id) {
            if(confirm("Eliminare?")) {
                entries = entries.filter(e => e.id !== id);
                save();
                updateUI();
            }
        }

        function save() { localStorage.setItem('aleta_v6_db', JSON.stringify(entries)); }

        function updateUI() {
            const balanceEl = document.getElementById('total-balance');
            const historyEl = document.getElementById('history-list');
            const total = entries.reduce((acc, curr) => acc + curr.amount, 0);
            balanceEl.innerText = `€ ${total.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
            balanceEl.className = `text-5xl font-black tracking-tight ${total >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;

            historyEl.innerHTML = entries.map(e => {
                const dateObj = new Date(e.date);
                return `
                <div class="bg-white p-5 rounded-[2rem] flex justify-between items-center card-shadow border border-slate-50">
                    <div class="flex-1">
                        <div class="font-black text-slate-800 text-lg">${e.desc}</div>
                        <div class="text-[10px] font-bold text-slate-300 uppercase tracking-widest italic">${dateObj.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="font-black text-lg ${e.type === 'out' ? 'text-blue-500' : 'text-orange-500'}">
                            ${e.type === 'out' ? '+' : '-'}${Math.abs(e.amount).toFixed(2)}€
                        </div>
                        <button onclick="editEntry(${e.id})" class="p-2 text-slate-300 active:text-blue-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-width="2.5"/></svg></button>
                        <button onclick="deleteEntry(${e.id})" class="p-2 text-slate-200 active:text-rose-500"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-width="2.5"/></svg></button>
                    </div>
                </div>`;
            }).join('');
        }

        function showPage(page) {
            ['home', 'history', 'settings'].forEach(p => {
                document.getElementById('page-' + p).classList.toggle('hidden', p !== page);
                document.getElementById('nav-' + p).style.opacity = p === page ? "1" : "0.3";
            });
        }

        document.getElementById('date').valueAsDate = new Date();
        updateUI();
    </script>
</body>
</html>
