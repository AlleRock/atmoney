<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AleTaMoney</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/AlleRock/atmoney/main/icona.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        .ios-blur { backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
        .hidden { display: none; }
        input::placeholder { color: #cbd5e1; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-28">

    <header class="sticky top-0 z-30 bg-white/80 ios-blur border-b border-slate-100 px-6 pt-14 pb-5 flex justify-between items-center">
        <h1 class="text-2xl font-black text-slate-800 tracking-tighter italic">AleTaMoney</h1>
        <button onclick="exportToCSV()" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-full text-xs font-bold active:scale-90 transition-all">CSV</button>
    </header>

    <main id="page-home" class="p-6 space-y-8 max-w-md mx-auto">
        <section class="bg-white rounded-[2.5rem] p-8 card-shadow border border-slate-50 relative overflow-hidden">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-50 rounded-full -mr-16 -mt-16 opacity-50"></div>
            <div class="relative z-10 text-center">
                <h2 class="text-[10px] uppercase tracking-[0.2em] text-slate-400 font-heavy mb-2 italic">Bilancio Crediti</h2>
                <div id="total-balance" class="text-5xl font-black tracking-tight transition-all duration-500">€ 0.00</div>
            </div>
        </section>

        <section class="bg-white rounded-3xl p-6 card-shadow border border-slate-50 space-y-4">
            <input id="edit-id" type="hidden"> <input id="desc" type="text" placeholder="Chi o per cosa?" class="w-full p-4 bg-slate-50 rounded-2xl outline-none focus:ring-2 ring-blue-100 transition-all text-lg font-medium">
            
            <div class="flex gap-3">
                <div class="relative flex-1">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">€</span>
                    <input id="amount" type="number" step="0.01" placeholder="0.00" class="w-full p-4 pl-8 bg-slate-50 rounded-2xl outline-none font-bold text-lg">
                </div>
                <input id="date" type="date" class="w-auto p-4 bg-slate-50 rounded-2xl outline-none text-xs font-bold text-slate-500">
            </div>

            <div class="grid grid-cols-2 gap-4 pt-2">
                <button id="btn-out" onclick="addEntry('out')" class="bg-blue-600 text-white font-extrabold py-5 rounded-2xl active:scale-[0.97] shadow-xl shadow-blue-200 transition-all">HO DATO</button>
                <button id="btn-in" onclick="addEntry('in')" class="bg-orange-500 text-white font-extrabold py-5 rounded-2xl active:scale-[0.97] shadow-xl shadow-orange-200 transition-all">TORNATI</button>
            </div>
            <button id="btn-cancel-edit" onclick="cancelEdit()" class="hidden w-full text-slate-400 text-xs font-bold py-2 uppercase tracking-widest">Annulla Modifica</button>
        </section>
    </main>

    <main id="page-history" class="hidden p-6 max-w-md mx-auto">
        <div class="flex items-center justify-between mb-8 px-2">
            <h2 class="text-3xl font-black text-slate-800 italic">Lista</h2>
            <div id="item-count" class="bg-slate-200 text-slate-600 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">0 Voci</div>
        </div>
        <div id="history-list" class="space-y-4"></div>
    </main>

    <nav class="fixed bottom-6 left-6 right-6 h-20 bg-white/90 ios-blur rounded-[2rem] card-shadow border border-white flex justify-around items-center px-4 z-40">
        <button onclick="showPage('home')" id="nav-home" class="flex flex-col items-center transition-all duration-300">
            <div class="p-3 rounded-2xl bg-blue-50 text-blue-600 mb-1" id="icon-home">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter">Inserisci</span>
        </button>
        <button onclick="showPage('history')" id="nav-history" class="flex flex-col items-center transition-all duration-300 opacity-30">
            <div class="p-3 rounded-2xl text-slate-400 mb-1" id="icon-history">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"></path></svg>
            </div>
            <span class="text-[10px] font-black uppercase tracking-tighter text-center">Storico</span>
        </button>
    </nav>

    <script>
        let entries = JSON.parse(localStorage.getItem('aleta_v4_db')) || [];

        function addEntry(type) {
            let desc = document.getElementById('desc').value;
            const amountVal = document.getElementById('amount').value;
            const date = document.getElementById('date').value;
            const editId = document.getElementById('edit-id').value;

            if (!amountVal || !date) return alert("Inserisci i dati mancanti");
            if (!desc && type === 'in') desc = "Rientro";
            if (!desc && type === 'out') return alert("A chi hai dato i soldi?");

            const amount = Math.abs(parseFloat(amountVal));
            
            if (editId) {
                // Modifica esistente
                const index = entries.findIndex(e => e.id == editId);
                entries[index] = { ...entries[index], desc, amount: type === 'out' ? amount : -amount, date, type };
                cancelEdit();
            } else {
                // Nuovo inserimento
                const entry = { id: Date.now(), desc, amount: type === 'out' ? amount : -amount, date, type };
                entries.unshift(entry);
            }

            save();
            updateUI();
            resetForm();
            showPage('history');
        }

        function editEntry(id) {
            const entry = entries.find(e => e.id == id);
            document.getElementById('edit-id').value = entry.id;
            document.getElementById('desc').value = entry.desc;
            document.getElementById('amount').value = Math.abs(entry.amount);
            document.getElementById('date').value = entry.date;
            
            document.getElementById('btn-cancel-edit').classList.remove('hidden');
            document.getElementById('btn-out').innerText = "CONFERMA DATO";
            document.getElementById('btn-in').innerText = "CONFERMA TORNATI";
            
            showPage('home');
        }

        function cancelEdit() {
            resetForm();
            document.getElementById('edit-id').value = '';
            document.getElementById('btn-cancel-edit').classList.add('hidden');
            document.getElementById('btn-out').innerText = "HO DATO";
            document.getElementById('btn-in').innerText = "TORNATI";
        }

        function resetForm() {
            document.getElementById('desc').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('date').valueAsDate = new Date();
        }

        function deleteEntry(id) {
            if(confirm("Eliminare definitivamente?")) {
                entries = entries.filter(e => e.id !== id);
                save();
                updateUI();
            }
        }

        function save() { localStorage.setItem('aleta_v4_db', JSON.stringify(entries)); }

        function updateUI() {
            const balanceEl = document.getElementById('total-balance');
            const historyEl = document.getElementById('history-list');
            const countEl = document.getElementById('item-count');
            
            const total = entries.reduce((acc, curr) => acc + curr.amount, 0);
            balanceEl.innerText = `€ ${total.toLocaleString('it-IT', {minimumFractionDigits: 2})}`;
            balanceEl.className = `text-5xl font-black tracking-tight ${total >= 0 ? 'text-emerald-500' : 'text-rose-500'}`;
            countEl.innerText = `${entries.length} Voci`;

            historyEl.innerHTML = entries.map(e => {
                const dateObj = new Date(e.date);
                const formattedDate = dateObj.toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' });
                
                return `
                <div class="bg-white p-5 rounded-[2rem] flex justify-between items-center card-shadow border border-slate-50">
                    <div class="flex-1">
                        <div class="font-black text-slate-800 text-lg leading-tight">${e.desc}</div>
                        <div class="text-[10px] font-bold text-slate-300 uppercase mt-1 italic tracking-widest">${formattedDate}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="text-right font-black text-lg mr-2 ${e.type === 'out' ? 'text-blue-500' : 'text-orange-500'}">
                            ${e.type === 'out' ? '+' : '-'}${Math.abs(e.amount).toFixed(2)}€
                        </div>
                        <button onclick="editEntry(${e.id})" class="bg-slate-50 p-2 rounded-xl text-slate-300 active:text-blue-500 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <button onclick="deleteEntry(${e.id})" class="bg-slate-50 p-2 rounded-xl text-slate-200 active:text-rose-400 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        function showPage(page) {
            document.getElementById('page-home').classList.toggle('hidden', page !== 'home');
            document.getElementById('page-history').classList.toggle('hidden', page !== 'history');
            const isHome = page === 'home';
            document.getElementById('nav-home').style.opacity = isHome ? "1" : "0.3";
            document.getElementById('nav-history').style.opacity = !isHome ? "1" : "0.3";
            document.getElementById('icon-home').classList.toggle('bg-blue-50', isHome);
            document.getElementById('icon-home').classList.toggle('text-blue-600', isHome);
            document.getElementById('icon-history').classList.toggle('bg-orange-50', !isHome);
            document.getElementById('icon-history').classList.toggle('text-orange-600', !isHome);
        }

        function exportToCSV() {
            if (entries.length === 0) return alert("Nessun dato!");
            let csv = "Data;Descrizione;Tipo;Importo\n";
            entries.forEach(e => csv += `${e.date};${e.desc};${e.type === 'out' ? 'Dato' : 'Tornato'};${Math.abs(e.amount).toFixed(2)}\n`);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `AleTaMoney_Full.csv`;
            link.click();
        }

        document.getElementById('date').valueAsDate = new Date();
        updateUI();
    </script>
</body>
</html>
